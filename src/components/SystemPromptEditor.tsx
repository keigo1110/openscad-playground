import React, { useState, useEffect, useRef } from 'react';
import { InputTextarea } from 'primereact/inputtextarea';
import { Button } from 'primereact/button';
import { Card } from 'primereact/card';
import { Badge } from 'primereact/badge';
import { Toast } from 'primereact/toast';
import { useTranslation } from 'react-i18next';
import { SystemPromptService } from '../services/system-prompt-service';

interface SystemPromptEditorProps {
  onPromptChange?: (prompt: string) => void;
}

export default function SystemPromptEditor({ onPromptChange }: SystemPromptEditorProps) {
  const { t } = useTranslation();
  const toast = useRef<Toast>(null);
  
  const [currentPrompt, setCurrentPrompt] = useState<string>('');
  const [isModified, setIsModified] = useState<boolean>(false);
  const [isInitialized, setIsInitialized] = useState<boolean>(false);

  // åˆæœŸåŒ–æ™‚ã«ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿
  useEffect(() => {
    const prompt = SystemPromptService.getCurrentPrompt();
    console.log('SystemPromptEditor: Loading initial prompt, length:', prompt.length);
    setCurrentPrompt(prompt);
    setIsModified(SystemPromptService.isModified());
    setIsInitialized(true);
    
    // åˆæœŸåŒ–æ™‚ã«è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ç¾åœ¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é€šçŸ¥
    if (onPromptChange) {
      onPromptChange(prompt);
    }
  }, []);

  // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå¤‰æ›´æ™‚ã®å‡¦ç†ï¼ˆå³åº§ã«ä¿å­˜ï¼‰
  const handlePromptChange = (newPrompt: string) => {
    console.log('SystemPromptEditor: Prompt changed, new length:', newPrompt.length);
    setCurrentPrompt(newPrompt);
    
    // å³åº§ã«LocalStorageã«ä¿å­˜
    try {
      SystemPromptService.savePrompt(newPrompt);
      console.log('SystemPromptEditor: Prompt saved to localStorage');
    } catch (error) {
      console.error('SystemPromptEditor: Failed to save prompt:', error);
    }
    
    const isNowModified = newPrompt !== SystemPromptService.getDefaultPrompt();
    setIsModified(isNowModified);
    
    // è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«å¤‰æ›´ã‚’é€šçŸ¥
    if (onPromptChange) {
      onPromptChange(newPrompt);
    }
  };

  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒªã‚»ãƒƒãƒˆ
  const handleReset = () => {
    try {
      const defaultPrompt = SystemPromptService.resetToDefault();
      console.log('SystemPromptEditor: Reset to default, length:', defaultPrompt.length);
      setCurrentPrompt(defaultPrompt);
      setIsModified(false);
      
      if (onPromptChange) {
        onPromptChange(defaultPrompt);
      }
      
      toast.current?.show({
        severity: 'info',
        summary: t('systemPrompt.resetComplete'),
        detail: t('systemPrompt.resetSuccess')
      });
    } catch (error) {
      console.error('SystemPromptEditor: Reset error:', error);
      toast.current?.show({
        severity: 'error',
        summary: t('common.error'),
        detail: error instanceof Error ? error.message : t('systemPrompt.resetError')
      });
    }
  };

  // æ‰‹å‹•ã§ã®å…¨é¸æŠæ©Ÿèƒ½
  const handleSelectAll = () => {
    const textarea = document.querySelector('textarea[placeholder*="ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ"]') as HTMLTextAreaElement;
    if (textarea) {
      textarea.select();
      console.log('SystemPromptEditor: Text selected');
    }
  };

  // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®çµ±è¨ˆæƒ…å ±ã‚’å–å¾—
  const stats = SystemPromptService.getPromptStats(currentPrompt);

  // åˆæœŸåŒ–ãŒå®Œäº†ã—ã¦ã„ãªã„å ´åˆã¯ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
  if (!isInitialized) {
    return (
      <div style={{ display: 'flex', justifyContent: 'center', padding: '20px' }}>
        <div>Loading system prompt...</div>
      </div>
    );
  }

  return (
    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
      <Toast ref={toast} />
      
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ± */}
      <Card>
        <div style={{ marginBottom: '16px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
            <h4 style={{ margin: 0 }}>
              ğŸ¤– {t('systemPrompt.title')}
            </h4>
            <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
              {isModified && (
                <Badge 
                  value={t('systemPrompt.modified')} 
                  severity="warning" 
                />
              )}
              {/* ãƒ‡ãƒãƒƒã‚°æƒ…å ± */}
              <small style={{ fontSize: '10px', color: '#999' }}>
                len: {currentPrompt.length}
              </small>
            </div>
          </div>
          <p style={{ margin: 0, color: '#6b7280', fontSize: '14px', marginBottom: '12px' }}>
            {t('systemPrompt.description')}
          </p>

          {/* çµ±è¨ˆæƒ…å ± */}
          <div style={{ 
            display: 'flex', 
            gap: '16px', 
            fontSize: '12px', 
            color: '#6b7280',
            marginBottom: '16px'
          }}>
            <span>ğŸ“„ {stats.lines} {t('systemPrompt.lines')}</span>
            <span>ğŸ”¤ {stats.characters} {t('systemPrompt.characters')}</span>
            <span>ğŸ’¬ {stats.words} {t('systemPrompt.words')}</span>
          </div>
          
          {/* ã‚¨ãƒ‡ã‚£ã‚¿ã‚¨ãƒªã‚¢ */}
          <div style={{ marginBottom: '16px' }}>
            <label style={{ 
              display: 'block', 
              marginBottom: '8px', 
              fontWeight: 'bold',
              fontSize: '14px' 
            }}>
              {t('systemPrompt.content')}
            </label>
            <InputTextarea
              id="system-prompt-textarea"
              value={currentPrompt}
              onChange={(e) => {
                console.log('InputTextarea onChange triggered, value length:', e.target.value.length);
                handlePromptChange(e.target.value);
              }}
              onFocus={() => console.log('SystemPromptEditor: Textarea focused')}
              onBlur={() => console.log('SystemPromptEditor: Textarea blurred')}
              rows={20}
              style={{ 
                width: '100%', 
                fontFamily: 'monospace',
                fontSize: '12px',
                lineHeight: '1.5',
                border: '1px solid #ddd',
                borderRadius: '4px',
                padding: '8px'
              }}
              placeholder={t('systemPrompt.placeholder')}
              readOnly={false}
              disabled={false}
              autoResize={false}
            />
          </div>

          {/* æ“ä½œã‚¨ãƒªã‚¢ */}
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            {/* ãƒ†ã‚¹ãƒˆç”¨ã®æ“ä½œ */}
            <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
              <span style={{ fontSize: '12px', color: '#666' }}>
                ç·¨é›†å¯èƒ½: âœ… | æ–‡å­—æ•°: {currentPrompt.length} | å³åº§ä¿å­˜: âœ…
              </span>
              <Button
                label="å…¨é¸æŠ"
                icon="pi pi-copy"
                className="p-button-text p-button-sm"
                onClick={handleSelectAll}
                style={{ fontSize: '10px' }}
              />
            </div>
            
            {/* ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ */}
            <Button
              label={t('systemPrompt.resetToDefault')}
              icon="pi pi-refresh"
              className="p-button-secondary p-button-sm"
              onClick={handleReset}
              disabled={!isModified}
            />
          </div>
        </div>
      </Card>
    </div>
  );
} 